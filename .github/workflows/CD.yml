name: CD - Pipeline
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  setup-minikube:
    runs-on: ubuntu-latest
    name: build images and deploy to minikube
    steps:
      - uses: actions/checkout@v4
      - name: Start minikube
        uses: medyagh/setup-minikube@master
      - name: Try the cluster !
        run: kubectl get pods -A
      - name: Build images
        run: |
          export SHELL=/bin/bash
          eval $(minikube -p minikube docker-env)
          cd Spring
          docker build -t backend/assignment .
          cd ../React
          docker build -t frontend/assignment .
          echo -n "verifying images:"
          docker images        
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      - name: Push backend image to Docker Hub
        run: docker tag backend/assignment your-dockerhub-username/backend-assignment:latest && docker push your-dockerhub-username/backend-assignment:latest
      - name: Push frontend image to Docker Hub
        run: docker tag frontend/assignment your-dockerhub-username/frontend-assignment:latest && docker push your-dockerhub-username/frontend-assignment:latest
      - name: Deploy to minikube
        run: |
          cd deployments
          kubectl apply -f deployment-backend.yaml
          kubectl apply -f deployment-frontend.yaml
      - name: Test service URLs
        run: |
          minikube service list
