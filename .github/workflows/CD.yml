name: CD - Pipeline
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  setup-minikube:
    runs-on: ubuntu-latest
    name: build images and deploy to minikube
    steps:
      - uses: actions/checkout@v4
      - name: Start minikube
        uses: medyagh/setup-minikube@master
      - name: Try the cluster !
        run: kubectl get pods -A
      - name: Build images
        run: |
          export SHELL=/bin/bash
          eval $(minikube -p minikube docker-env)
          cd Spring
          docker build -t backend/assignment .
          cd ../React
          docker build -t frontend/assignment .
          echo -n "verifying images:"
          docker images        
      - name: Deploy to minikube
        run: |
          kubectl apply -f deployment-backend.yaml
          kubectl apply -f deployment-frontend.yaml
      - name: Test service URLs
        run: |
          minikube service list